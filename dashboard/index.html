<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StatPulse ‚Äî SIS-CC .Stat Suite API Monitor</title>
  <meta name="description" content="Real-time API health dashboard for the SIS-CC .Stat Suite SDMX platform. Tracks uptime, response times, and data quality metrics." />

  <!-- Chart.js is the only external dependency ‚Äî loaded from a pinned CDN
       version so the dashboard works even without a build step. -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

  <style>
    /* -----------------------------------------------------------------------
       Design tokens ‚Äî all colours are defined here so tweaking the palette
       never requires hunting through scattered inline values.
    ----------------------------------------------------------------------- */
    :root {
      --bg-primary:   #0d1117;
      --bg-card:      #161b22;
      --bg-card-alt:  #1c2128;
      --border:       #30363d;
      --accent:       #2f81f7;
      --accent-hover: #388bfd;
      --green:        #3fb950;
      --yellow:       #d29922;
      --red:          #f85149;
      --text-primary: #e6edf3;
      --text-muted:   #8b949e;
      --text-link:    #58a6ff;
      --radius:       8px;
      --shadow:       0 1px 3px rgba(0,0,0,0.4);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
      font-size: 14px;
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    a { color: var(--text-link); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* -----------------------------------------------------------------------
       Layout
    ----------------------------------------------------------------------- */
    header {
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .header-title { flex: 1; min-width: 200px; }

    .wordmark {
      font-size: 22px;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: -0.5px;
    }

    .subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }

    .header-meta {
      font-size: 12px;
      color: var(--text-muted);
      text-align: right;
      white-space: nowrap;
    }

    .header-meta strong { color: var(--text-primary); }

    main {
      flex: 1;
      padding: 24px;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    section + section { margin-top: 40px; }

    h2 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
    }

    footer {
      border-top: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: center;
      font-size: 12px;
      color: var(--text-muted);
    }

    footer a { margin: 0 4px; }

    .footer-disclaimer {
      flex: 1;
      text-align: right;
      font-style: italic;
      min-width: 260px;
    }

    /* -----------------------------------------------------------------------
       Status cards grid
    ----------------------------------------------------------------------- */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 16px;
    }

    .card-name {
      font-size: 15px;
      font-weight: 600;
    }

    .badge {
      font-size: 11px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    .badge-operational { background: rgba(63,185,80,0.15); color: var(--green); }
    .badge-degraded    { background: rgba(210,153,34,0.15); color: var(--yellow); }
    .badge-down        { background: rgba(248,81,73,0.15);  color: var(--red); }
    .badge-pending     { background: rgba(139,148,158,0.15); color: var(--text-muted); }

    .card-metrics {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .metric-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 2px;
    }

    .metric-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .metric-value.good   { color: var(--green); }
    .metric-value.warn   { color: var(--yellow); }
    .metric-value.bad    { color: var(--red); }
    .metric-value.muted  { color: var(--text-muted); font-size: 15px; }

    .anomaly-warn {
      font-size: 11px;
      color: var(--yellow);
      margin-top: 5px;
      font-weight: 500;
    }

    .anomaly-description {
      font-size: 13px;
      color: var(--text-muted);
      padding: 12px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }

    /* -----------------------------------------------------------------------
       Charts
    ----------------------------------------------------------------------- */
    .chart-container {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
    }

    canvas { display: block; width: 100% !important; }

    /* -----------------------------------------------------------------------
       Extra-metric table
    ----------------------------------------------------------------------- */
    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead th {
      text-align: left;
      padding: 10px 12px;
      background: var(--bg-card-alt);
      color: var(--text-muted);
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border);
    }

    tbody tr:nth-child(even) { background: var(--bg-card-alt); }
    tbody tr:hover { background: rgba(47,129,247,0.06); }

    tbody td {
      padding: 9px 12px;
      border-bottom: 1px solid var(--border);
      color: var(--text-primary);
    }

    /* -----------------------------------------------------------------------
       Loading / error / empty states
    ----------------------------------------------------------------------- */
    .state-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 24px;
      text-align: center;
      color: var(--text-muted);
    }

    .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .state-icon { font-size: 36px; margin-bottom: 12px; }
    .state-message { font-size: 15px; color: var(--text-primary); margin-bottom: 6px; }
    .state-detail  { font-size: 13px; }

    /* Hidden utility */
    .hidden { display: none !important; }

    /* -----------------------------------------------------------------------
       Responsive
    ----------------------------------------------------------------------- */
    @media (max-width: 600px) {
      main { padding: 16px; }
      .card-metrics { grid-template-columns: 1fr; }
      .header-meta { text-align: left; }
    }

    /* -----------------------------------------------------------------------
       Weekly reports section
    ----------------------------------------------------------------------- */
    .reports-wrapper {
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      padding: 0 24px 40px;
    }

    .reports-list { display: flex; flex-direction: column; gap: 12px; }

    .report-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      cursor: pointer;
      transition: border-color 0.15s;
      box-shadow: var(--shadow);
    }

    .report-card:hover { border-color: rgba(47, 129, 247, 0.4); }

    .report-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      flex-wrap: wrap;
      /* user-select prevents text selection flash when clicking to expand */
      user-select: none;
    }

    .report-card-title {
      flex: 1;
      min-width: 200px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .report-card-meta {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    .report-card-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .btn-outline {
      padding: 6px 12px;
      font-size: 0.8rem;
      border: 1px solid var(--accent);
      color: var(--accent);
      background: transparent;
      border-radius: var(--radius);
      cursor: pointer;
      transition: background 0.15s;
      text-decoration: none;
      white-space: nowrap;
    }

    .btn-outline:hover {
      background: rgba(47, 129, 247, 0.1);
      text-decoration: none;
      color: var(--accent);
    }

    .btn-filled {
      padding: 6px 12px;
      font-size: 0.8rem;
      border: none;
      color: #fff;
      background: var(--accent);
      border-radius: var(--radius);
      cursor: pointer;
      transition: background 0.15s;
      white-space: nowrap;
    }

    .btn-filled:hover { background: var(--accent-hover); }

    .badge-open   { background: rgba(63,185,80,0.15);     color: var(--green); }
    .badge-closed { background: rgba(139,148,158,0.15);   color: var(--text-muted); }

    /* max-height transition gives a smooth expand/collapse without JS animation frames */
    .report-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.35s ease;
    }

    .report-body.expanded { max-height: 2000px; }

    .report-body-inner {
      padding: 16px 20px 16px 23px;
      background: var(--bg-card-alt);
      border-top: 1px solid var(--border);
      border-left: 3px solid var(--accent);
      font-size: 13px;
      line-height: 1.7;
      color: var(--text-muted);
    }

    .report-body-inner h4 {
      font-size: 13px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 14px 0 6px;
    }

    .report-body-inner h4:first-child { margin-top: 0; }

    .report-body-inner p { margin: 4px 0; }

    .report-body-inner strong { color: var(--text-primary); }

    .report-body-inner ul { margin: 6px 0 6px 16px; }

    .report-body-inner li { margin: 2px 0; }

    .report-body-inner hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 12px 0;
    }

    /* Report tables reuse the existing table styles via inheritance */
    .report-body-inner table { margin: 10px 0; }

    .reports-state {
      padding: 24px;
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }

    .reports-spinner {
      width: 18px;
      height: 18px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
      margin-right: 8px;
      vertical-align: middle;
    }

    @media (max-width: 600px) {
      .reports-wrapper { padding: 0 16px 32px; }
      .report-card-actions { flex-wrap: wrap; }
    }

    /* -----------------------------------------------------------------------
       SDMX Guide Panel ‚Äî floating trigger button + slide-in reference overlay
    ----------------------------------------------------------------------- */

    /* Locking body scroll via a class (rather than an inline style) keeps all
       styling declarative and consistent with the class-driven approach used
       throughout the rest of the dashboard. */
    body.panel-open { overflow: hidden; }

    /* Fixed pill sits above all page content. z-index 1000 is the base of the
       guide layer stack ‚Äî overlay is 1001, panel is 1002. */
    .guide-btn {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 1000;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 24px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 14px rgba(0,0,0,0.5);
      transition: background 0.15s, transform 0.1s;
    }

    .guide-btn:hover  { background: var(--accent-hover); }
    .guide-btn:active { transform: scale(0.97); }

    /* Overlay fades in separately from the panel slide so both transitions
       can have different durations without JavaScript animation frames. */
    .guide-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 1001;
      opacity: 0;
      transition: opacity 0.25s;
      /* opacity:0 still intercepts pointer events ‚Äî disable them when
         the overlay is not active so the rest of the page stays clickable. */
      pointer-events: none;
    }

    .guide-overlay.visible { opacity: 1; pointer-events: auto; }

    /* Panel starts fully offscreen (translateX 100%) so it cannot intercept
       pointer events when closed. cubic-bezier matches Material Design's
       standard decelerate easing for elements entering the viewport. */
    .guide-panel {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: 480px;
      max-width: 100vw;
      z-index: 1002;
      background: var(--bg-card);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }

    .guide-panel.open { transform: translateX(0); }

    .guide-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .guide-panel-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .guide-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 22px;
      line-height: 1;
      cursor: pointer;
      padding: 2px 7px;
      border-radius: 4px;
      transition: color 0.15s, background 0.15s;
    }

    .guide-close:hover {
      color: var(--text-primary);
      background: var(--bg-card-alt);
    }

    /* Tab bar scrolls horizontally on narrow viewports rather than wrapping
       or truncating the tab labels. */
    .guide-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      overflow-x: auto;
    }

    .guide-tab {
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 500;
      padding: 10px 14px;
      cursor: pointer;
      white-space: nowrap;
      transition: color 0.15s, border-color 0.15s;
      /* Negative margin aligns the 2px active indicator flush with
         the container's 1px bottom border. */
      margin-bottom: -1px;
    }

    .guide-tab:hover { color: var(--text-primary); }

    .guide-tab.active {
      color: var(--text-primary);
      border-bottom-color: var(--accent);
      font-weight: 600;
    }

    /* Scrollable content area grows to fill available panel height so the
       tab bar and header stay pinned while content scrolls independently. */
    .guide-tab-content {
      flex: 1;
      overflow-y: auto;
    }

    .guide-tabpanel {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .guide-tabpanel.hidden { display: none; }

    .guide-section-title {
      font-size: 17px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
      /* Reset h3/h4 browser defaults since this appears inside an aside */
      border-bottom: none;
      padding-bottom: 0;
    }

    /* Smaller heading for sub-sections within a tab panel */
    .guide-subsection-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 10px;
      border-bottom: none;
      padding-bottom: 0;
    }

    .guide-prose {
      font-size: 13px;
      line-height: 1.7;
      color: var(--text-muted);
    }

    /* ‚îÄ‚îÄ Architecture flow diagram (Tab 1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

    /* flex-wrap lets the diagram reflow vertically on narrow viewports
       without needing media queries for the internal layout. */
    .flow-diagram {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
      padding: 12px 0;
    }

    .flow-box {
      background: var(--bg-card-alt);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 14px;
      text-align: center;
      flex: 1;
      min-width: 110px;
    }

    .flow-icon  { font-size: 20px; display: block; margin-bottom: 4px; }
    .flow-label { font-size: 12px; font-weight: 600; color: var(--text-primary); }
    .flow-desc  { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

    .flow-arrow {
      font-size: 20px;
      color: var(--accent);
      flex-shrink: 0;
      font-weight: 700;
    }

    /* ‚îÄ‚îÄ Why-it-matters cards (Tab 1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

    .why-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .why-card {
      background: var(--bg-card-alt);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 12px;
    }

    .why-icon  { font-size: 18px; display: block; margin-bottom: 6px; }
    .why-title { font-size: 12px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px; }
    .why-text  { font-size: 11px; color: var(--text-muted); line-height: 1.5; margin: 0; }

    /* ‚îÄ‚îÄ Accordion glossary (Tab 2) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

    .accordion { display: flex; flex-direction: column; gap: 4px; }

    .accordion-item {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .accordion-trigger {
      width: 100%;
      background: var(--bg-card-alt);
      border: none;
      color: var(--text-primary);
      font-size: 13px;
      font-weight: 600;
      padding: 11px 14px;
      text-align: left;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.15s;
    }

    .accordion-trigger:hover { background: rgba(47,129,247,0.07); }

    /* CSS handles the chevron rotation ‚Äî no JS animation frames needed.
       The .open class is toggled on .accordion-item by JS. */
    .accordion-chevron {
      font-size: 10px;
      display: inline-block;
      transition: transform 0.2s ease;
      flex-shrink: 0;
      color: var(--text-muted);
    }

    .accordion-item.open .accordion-chevron { transform: rotate(90deg); }

    /* Same max-height transition pattern as .report-body ‚Äî keeps animation
       behaviour consistent across expandable content in the dashboard. */
    .accordion-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.25s ease;
    }

    .accordion-body.expanded { max-height: 600px; }

    .accordion-body-inner {
      padding: 12px 14px 14px;
      background: var(--bg-card);
      border-top: 1px solid var(--border);
      font-size: 13px;
      line-height: 1.65;
      color: var(--text-muted);
    }

    .accordion-body-inner p { margin: 0 0 8px; }
    .accordion-body-inner p:last-of-type { margin-bottom: 0; }

    /* Tag pills use accent at ~18% opacity so they stand out against the
       card background without competing with the prose text hierarchy. */
    .tag-list { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; }

    .tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      background: rgba(47,129,247,0.18);
      color: var(--accent);
      font-weight: 500;
    }

    /* ‚îÄ‚îÄ API anatomy code block (Tab 2) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

    .api-anatomy {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 16px;
      font-size: 11px;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      color: var(--text-primary);
      overflow-x: auto;
      white-space: pre;
      line-height: 1.8;
      margin: 0;
    }

    /* Monospace inline code used in static HTML tables (distinct from the
       dynamically-injected code spans in the markdown renderer). */
    .code-mono {
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 0.85em;
      background: var(--bg-primary);
      padding: 1px 5px;
      border-radius: 3px;
    }

    /* ‚îÄ‚îÄ How-to-read blocks (Tab 3) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

    .howto-block {
      display: flex;
      gap: 14px;
      align-items: flex-start;
    }

    .howto-icon {
      font-size: 22px;
      flex-shrink: 0;
      line-height: 1;
      padding-top: 1px;
    }

    .howto-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .howto-text {
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.65;
      margin: 0;
    }

    @media (max-width: 600px) {
      .guide-btn { bottom: 16px; right: 16px; font-size: 13px; padding: 9px 16px; }
      .why-cards { grid-template-columns: 1fr; }
      /* Rotate arrows so the vertically-wrapped flow diagram reads top-to-bottom */
      .flow-arrow { transform: rotate(90deg); }
    }

    /* -----------------------------------------------------------------------
       Platform Reports ‚Äî tabbed section wrapper replacing .reports-wrapper
    ----------------------------------------------------------------------- */
    .reports-section {
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      padding: 0 24px 40px;
    }

    .section-header { margin-bottom: 20px; }

    /* Override global h2 border-bottom so the section title has no underline */
    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
      border-bottom: none;
      padding-bottom: 0;
    }

    .section-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* Tab bar ‚Äî negative margin seats the 3px active indicator flush with
       the container's 1px bottom border, matching the guide panel pattern. */
    .reports-tab-bar {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 0;
      gap: 0;
    }

    .reports-tab {
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 500;
      padding: 12px 20px;
      cursor: pointer;
      transition: color 0.15s, border-color 0.15s;
      white-space: nowrap;
      margin-bottom: -1px;
    }

    .reports-tab:hover { color: var(--text-primary); }

    .reports-tab.active {
      color: var(--text-primary);
      border-bottom-color: var(--accent);
      font-weight: 600;
    }

    /* Tab panels share the same top padding so content starts at a
       consistent distance from the tab bar on both tabs. */
    #tab-weekly,
    #tab-catalogue { padding-top: 24px; }

    /* -----------------------------------------------------------------------
       Catalogue Change Report
    ----------------------------------------------------------------------- */
    .catalogue-summary-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }

    .catalogue-stat-card {
      background: var(--bg-card-alt);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      text-align: center;
    }

    .catalogue-stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--accent);
      display: block;
      line-height: 1.2;
    }

    /* Colour variants communicate net-change direction at a glance */
    .catalogue-stat-value.positive { color: var(--green); }
    .catalogue-stat-value.negative { color: var(--red); }
    .catalogue-stat-value.neutral  { color: var(--text-muted); }

    .catalogue-stat-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 4px;
      display: block;
    }

    .sparkline-wrapper {
      background: var(--bg-card-alt);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 24px;
    }

    .sparkline-title {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .sparkline-duo {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .sparkline-item-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    /* The left border acts as the connecting vertical line for the timeline;
       padding-left offsets event content past the dot markers. */
    .catalogue-timeline {
      position: relative;
      padding-left: 24px;
      border-left: 2px solid var(--border);
      display: flex;
      flex-direction: column;
    }

    .catalogue-event {
      position: relative;
      padding: 0 0 24px 20px;
    }

    /* Dot overlaps the vertical border line ‚Äî border matches bg-primary
       to create a "punched out" ring effect without pseudo-elements. */
    .event-dot {
      position: absolute;
      left: -28px;
      top: 4px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid var(--bg-primary);
    }

    .event-dot.baseline { background: var(--green); }
    .event-dot.addition { background: var(--green); }
    .event-dot.deletion { background: var(--red); }
    .event-dot.mixed    { background: var(--yellow); }

    .event-timestamp {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .event-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .event-baseline-note {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Compact delta table ‚Äî overrides global table/thead/td styles with
       more specific selectors so inline-report rows stay tight. */
    .event-delta-table {
      font-size: 12px;
      border-collapse: collapse;
      width: 100%;
      max-width: 340px;
    }

    .event-delta-table td,
    .event-delta-table th {
      padding: 4px 10px;
      border: 1px solid var(--border);
      text-align: left;
    }

    .event-delta-table th {
      background: var(--bg-primary);
      color: var(--text-muted);
      font-weight: 500;
      text-transform: none;
      letter-spacing: normal;
      font-size: 12px;
    }

    /* Suppress global zebra-striping inside the compact delta table */
    .event-delta-table tbody tr:nth-child(even) { background: transparent; }

    .delta-positive { color: var(--green); font-weight: 600; }
    .delta-negative { color: var(--red);   font-weight: 600; }

    .catalogue-empty-state {
      padding: 32px 0;
      color: var(--text-muted);
      font-size: 13px;
      text-align: center;
      line-height: 1.7;
    }

    .catalogue-footer-note {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 16px;
      font-style: italic;
      line-height: 1.6;
    }

    @media (max-width: 600px) {
      .reports-section { padding: 0 16px 32px; }
      .catalogue-summary-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>

  <header>
    <div class="header-title">
      <div class="wordmark">statpulse</div>
      <div class="subtitle">SIS-CC .Stat Suite API Monitor</div>
    </div>
    <div class="header-meta">
      Auto-updates every 6h<br>
      Last updated: <strong id="last-updated">‚Äî</strong>
    </div>
  </header>

  <!-- Loading state ‚Äî visible until data loads or an error occurs -->
  <div id="loading-state" class="state-container" role="status" aria-live="polite" aria-label="Loading health data">
    <div class="spinner" aria-hidden="true"></div>
    <div class="state-message">Loading health data‚Ä¶</div>
    <div class="state-detail">Fetching health-log.json</div>
  </div>

  <!-- Error state ‚Äî shown when fetch or parse fails -->
  <div id="error-state" class="state-container hidden" role="alert" aria-live="assertive">
    <div class="state-icon" aria-hidden="true">‚ö†Ô∏è</div>
    <div class="state-message">Could not load health data</div>
    <div class="state-detail" id="error-detail"></div>
  </div>

  <!-- Empty state ‚Äî shown when health-log.json is an empty array -->
  <div id="empty-state" class="state-container hidden" role="status">
    <div class="state-icon" aria-hidden="true">üïê</div>
    <div class="state-message">No data yet ‚Äî first check pending</div>
    <div class="state-detail">GitHub Actions will populate this dashboard on the next scheduled run.</div>
  </div>

  <!-- Main dashboard ‚Äî hidden until data is ready -->
  <main id="dashboard" class="hidden" aria-label="API health dashboard">

    <!-- Status cards -->
    <section aria-labelledby="status-heading">
      <h2 id="status-heading">Endpoint Status</h2>
      <div class="cards-grid" id="cards-grid" role="list" aria-label="Endpoint status cards">
        <!-- Injected by JS -->
      </div>
    </section>

    <!-- Anomaly detection info -->
    <section aria-labelledby="anomaly-heading">
      <h2 id="anomaly-heading">Anomaly Detection</h2>
      <p class="anomaly-description">
        Response times are compared against a 10-check rolling average.
        Deviations above 2√ó trigger a warning; above 3√ó trigger a critical alert.
      </p>
    </section>

    <!-- Response-time chart -->
    <section aria-labelledby="chart-heading">
      <h2 id="chart-heading">Response Times ‚Äî Last 20 Checks</h2>
      <div class="chart-container">
        <canvas id="response-chart" role="img" aria-label="Line chart showing response times over the last 20 health checks for all three SDMX endpoints"></canvas>
      </div>
    </section>

    <!-- Extra-metric trends table -->
    <section aria-labelledby="metrics-heading">
      <h2 id="metrics-heading">Domain Metric Trends</h2>
      <div class="table-wrapper">
        <table aria-label="Domain-specific metric values over time">
          <thead>
            <tr>
              <th scope="col">Timestamp</th>
              <th scope="col">Structures (DSD count)</th>
              <th scope="col">Data Query (KB)</th>
              <th scope="col">Codelists (count)</th>
            </tr>
          </thead>
          <tbody id="metrics-tbody">
            <!-- Injected by JS -->
          </tbody>
        </table>
      </div>
    </section>

  </main>

  <!-- Platform Reports ‚Äî tabbed section with Weekly Health Reports and Catalogue Changes.
       The weekly tab fetches GitHub Issues API independently of health-log.json so it
       remains visible even if the health data fetch fails. The catalogue tab is populated
       by renderCatalogueReport() after health-log.json loads successfully. -->
  <section class="reports-section" aria-labelledby="platform-reports-heading">
    <div class="section-header">
      <h2 id="platform-reports-heading" class="section-title">Platform Reports</h2>
      <p class="section-subtitle">Automated analysis and governance intelligence</p>
    </div>

    <div class="reports-tab-bar" role="tablist" aria-label="Report types">
      <button class="reports-tab active" role="tab" aria-selected="true"
              aria-controls="tab-weekly" id="rtab-weekly">üìã Weekly Health Reports</button>
      <button class="reports-tab" role="tab" aria-selected="false"
              aria-controls="tab-catalogue" id="rtab-catalogue">üóÇ Catalogue Changes</button>
    </div>

    <div id="tab-weekly" role="tabpanel" aria-labelledby="rtab-weekly">
      <div id="reports-loading" class="reports-state" role="status" aria-live="polite">
        <span class="reports-spinner" aria-hidden="true"></span>Loading reports‚Ä¶
      </div>
      <div id="reports-error" class="reports-state hidden" role="alert">
        Unable to load reports ‚Äî view them directly on
        <a href="https://github.com/erenkahraman/statpulse/issues?q=label%3Aweekly-report"
           target="_blank" rel="noopener noreferrer">GitHub</a>
      </div>
      <div id="reports-empty" class="reports-state hidden" role="status">
        No weekly reports generated yet ‚Äî the first report runs every Monday at 09:00 UTC
      </div>
      <div id="reports-list" class="reports-list hidden"
           role="list" aria-label="Weekly health report issues"></div>
    </div>

    <div id="tab-catalogue" role="tabpanel" aria-labelledby="rtab-catalogue" class="hidden">
      <div id="catalogue-container"><!-- Injected by JS after health-log.json loads --></div>
    </div>
  </section>

  <footer>
    <div>
      <a href="https://sis-cc.gitlab.io/dotstatsuite-documentation/" target="_blank" rel="noopener noreferrer">SIS-CC Docs</a>
      &bull;
      <a href="https://github.com/erenkahraman/statpulse" target="_blank" rel="noopener noreferrer">GitHub Repo</a>
    </div>
    <div class="footer-disclaimer">
      Built as a portfolio project for OECD SDD/SDPS PM role | Not officially affiliated with OECD or SIS-CC
    </div>
  </footer>

  <script>
    // -------------------------------------------------------------------------
    // Constants
    // -------------------------------------------------------------------------

    // How many recent checks to plot on the response-time chart.
    // 20 balances readability vs. showing enough trend context.
    const CHART_WINDOW = 20;

    // Endpoint names exactly as written in check-health.js ‚Äî used to filter
    // the flat log array into per-endpoint series.
    const ENDPOINT_NAMES = ['Structures', 'Data Query', 'Codelists'];

    // Chart line colours match the GitHub colour palette used elsewhere in the UI.
    const LINE_COLORS = {
      'Structures':  '#2f81f7',
      'Data Query':  '#3fb950',
      'Codelists':   '#d29922',
    };

    // Response-time thresholds for colouring the metric value in cards.
    const RESPONSE_WARN_MS  = 2000;
    const RESPONSE_BAD_MS   = 3000;
    const UPTIME_WARN_PCT   = 99;
    const UPTIME_BAD_PCT    = 95;

    // -------------------------------------------------------------------------
    // DOM references ‚Äî cached once to avoid repeated querySelector calls
    // -------------------------------------------------------------------------
    const $loading   = document.getElementById('loading-state');
    const $error     = document.getElementById('error-state');
    const $errorDet  = document.getElementById('error-detail');
    const $empty     = document.getElementById('empty-state');
    const $dashboard = document.getElementById('dashboard');
    const $lastUpd   = document.getElementById('last-updated');
    const $cards     = document.getElementById('cards-grid');
    const $tbody     = document.getElementById('metrics-tbody');

    // -------------------------------------------------------------------------
    // State transitions ‚Äî exactly one state visible at a time
    // -------------------------------------------------------------------------

    function showError(message) {
      $loading.classList.add('hidden');
      $errorDet.textContent = message;
      $error.classList.remove('hidden');
    }

    function showEmpty() {
      $loading.classList.add('hidden');
      $empty.classList.remove('hidden');
    }

    function showDashboard() {
      $loading.classList.add('hidden');
      $dashboard.classList.remove('hidden');
    }

    // -------------------------------------------------------------------------
    // Data helpers
    // -------------------------------------------------------------------------

    /**
     * Groups the flat log array into one array per endpoint, sorted oldest‚Üínewest.
     * Filtering by endpoint name rather than assuming positional order makes the
     * code resilient to future additions or re-ordering of endpoints.
     * @param {Array} log
     * @returns {Object} Map of endpointName ‚Üí sorted records
     */
    function groupByEndpoint(log) {
      const groups = {};
      for (const name of ENDPOINT_NAMES) {
        groups[name] = log
          .filter(r => r.endpoint === name)
          .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      }
      return groups;
    }

    /**
     * Computes uptime percentage for a set of records.
     * @param {Array} records
     * @returns {string} Formatted percentage string
     */
    function uptimePercent(records) {
      if (!records.length) return '‚Äî';
      const ok = records.filter(r => r.ok).length;
      return ((ok / records.length) * 100).toFixed(1) + '%';
    }

    /**
     * Returns a CSS class name based on a numeric uptime value.
     * @param {string} pctStr
     */
    function uptimeClass(pctStr) {
      const v = parseFloat(pctStr);
      if (isNaN(v)) return 'muted';
      if (v >= UPTIME_WARN_PCT) return 'good';
      if (v >= UPTIME_BAD_PCT)  return 'warn';
      return 'bad';
    }

    /**
     * Returns a CSS class name based on a response time in ms.
     * @param {number|null} ms
     */
    function responseClass(ms) {
      if (ms === null || ms === undefined) return 'muted';
      if (ms < RESPONSE_WARN_MS) return 'good';
      if (ms < RESPONSE_BAD_MS)  return 'warn';
      return 'bad';
    }

    /**
     * Determines operational status from the most recent record.
     * Anomaly detection overrides OPERATIONAL: a warning-severity anomaly
     * shows DEGRADED in yellow; a critical-severity anomaly shows DEGRADED
     * in red (using badge-down styling) to communicate urgency without
     * conflating it with a true HTTP failure (which shows DOWN).
     * @param {Object|null} latest
     * @param {string} uptime
     * @returns {{ label: string, cssClass: string }}
     */
    function statusBadge(latest, uptime) {
      if (!latest) return { label: 'PENDING', cssClass: 'badge-pending' };
      if (!latest.ok) return { label: 'DOWN', cssClass: 'badge-down' };
      // Anomaly severity takes precedence over uptime-based DEGRADED check.
      if (latest.anomaly?.detected) {
        if (latest.anomaly.severity === 'critical') return { label: 'DEGRADED', cssClass: 'badge-down' };
        return { label: 'DEGRADED', cssClass: 'badge-degraded' };
      }
      const v = parseFloat(uptime);
      if (!isNaN(v) && v < UPTIME_WARN_PCT) return { label: 'DEGRADED', cssClass: 'badge-degraded' };
      return { label: 'OPERATIONAL', cssClass: 'badge-operational' };
    }

    /**
     * Formats a timestamp for display in the user's local timezone.
     * Using toLocaleString() avoids the overhead of a date library while still
     * giving users a human-readable representation in their own timezone.
     * @param {string} isoString
     * @returns {string}
     */
    function formatLocal(isoString) {
      try {
        return new Date(isoString).toLocaleString();
      } catch {
        return isoString;
      }
    }

    /**
     * Formats a timestamp for the chart x-axis labels (shorter).
     * @param {string} isoString
     * @returns {string}
     */
    function formatChartLabel(isoString) {
      try {
        const d = new Date(isoString);
        return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })
          + ' ' + d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
      } catch {
        return isoString;
      }
    }

    // -------------------------------------------------------------------------
    // Rendering
    // -------------------------------------------------------------------------

    /**
     * Renders the three status cards.
     * @param {Object} groups - Output of groupByEndpoint()
     */
    function renderCards(groups) {
      $cards.innerHTML = '';

      for (const name of ENDPOINT_NAMES) {
        const records = groups[name];
        const latest  = records.length ? records[records.length - 1] : null;
        const uptime  = uptimePercent(records);
        const badge   = statusBadge(latest, uptime);
        const respMs  = latest?.responseTimeMs ?? null;

        const anomaly = latest?.anomaly;
        // Build anomaly warning line only when an anomaly is detected so
        // normal operational cards stay visually clean.
        const anomalyHtml = anomaly?.detected
          ? `<div class="anomaly-warn" role="alert" aria-label="Anomaly detected">` +
            `‚ö† ${anomaly.deviationFactor}√ó above rolling avg (${anomaly.rollingAvgMs}ms)</div>`
          : '';

        const article = document.createElement('article');
        article.className = 'card';
        article.setAttribute('role', 'listitem');
        article.setAttribute('aria-label', `${name} endpoint status: ${badge.label}`);

        article.innerHTML = `
          <div class="card-header">
            <span class="card-name">${name}</span>
            <span class="badge ${badge.cssClass}" role="status">${badge.label}</span>
          </div>
          <div class="card-metrics">
            <div>
              <div class="metric-label">Response time</div>
              <div class="metric-value ${responseClass(respMs)}">
                ${respMs !== null ? respMs + 'ms' : '‚Äî'}
              </div>
              ${anomalyHtml}
            </div>
            <div>
              <div class="metric-label">Uptime (all checks)</div>
              <div class="metric-value ${uptimeClass(uptime)}">${uptime}</div>
            </div>
          </div>
        `;

        $cards.appendChild(article);
      }
    }

    /**
     * Renders the response-time line chart using Chart.js.
     * @param {Object} groups - Output of groupByEndpoint()
     */
    function renderChart(groups) {
      // Use the Structures endpoint's last CHART_WINDOW timestamps as x-axis
      // labels ‚Äî all endpoints are checked together so timestamps align closely.
      const referenceRecords = (groups['Structures'] || []).slice(-CHART_WINDOW);
      const labels = referenceRecords.map(r => formatChartLabel(r.timestamp));

      const datasets = ENDPOINT_NAMES.map(name => {
        const records = (groups[name] || []).slice(-CHART_WINDOW);
        return {
          label: name,
          data: records.map(r => r.responseTimeMs ?? null),
          borderColor: LINE_COLORS[name],
          backgroundColor: LINE_COLORS[name] + '20', // 12% opacity fill
          borderWidth: 2,
          pointRadius: 3,
          pointHoverRadius: 5,
          tension: 0.3,
          spanGaps: true, // Draw a line through null values (timeouts)
        };
      });

      const ctx = document.getElementById('response-chart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: {
              labels: { color: '#8b949e', font: { size: 12 } }
            },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y !== null ? ctx.parsed.y + 'ms' : 'timeout'}`
              }
            }
          },
          scales: {
            x: {
              ticks: { color: '#8b949e', maxRotation: 40, font: { size: 11 } },
              grid:  { color: '#21262d' }
            },
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Response time (ms)', color: '#8b949e' },
              ticks: {
                color: '#8b949e',
                callback: v => v + 'ms'
              },
              grid: { color: '#21262d' }
            }
          }
        }
      });
    }

    /**
     * Renders the domain-metric trends table.
     * Rows are shown newest-first so the most recent data is immediately visible.
     * @param {Object} groups - Output of groupByEndpoint()
     */
    function renderMetricsTable(groups) {
      // Build a lookup by timestamp so we can join the three per-endpoint series.
      const structRecs  = (groups['Structures'] || []).slice().reverse();
      const dataRecs    = (groups['Data Query'] || []).slice().reverse();
      const codeRecs    = (groups['Codelists'] || []).slice().reverse();

      // Use the longest series as the row driver ‚Äî in practice all three run
      // together so they'll have the same timestamps.
      const maxLen = Math.max(structRecs.length, dataRecs.length, codeRecs.length);

      $tbody.innerHTML = '';
      for (let i = 0; i < maxLen; i++) {
        const s = structRecs[i];
        const d = dataRecs[i];
        const c = codeRecs[i];
        const ts = (s || d || c)?.timestamp;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${ts ? formatLocal(ts) : '‚Äî'}</td>
          <td>${s?.extraMetric?.value ?? '‚Äî'}</td>
          <td>${d?.extraMetric?.value ?? '‚Äî'}</td>
          <td>${c?.extraMetric?.value ?? '‚Äî'}</td>
        `;
        $tbody.appendChild(tr);
      }
    }

    // -------------------------------------------------------------------------
    // Main data-fetch flow
    // -------------------------------------------------------------------------

    async function init() {
      try {
        const res = await fetch('./health-log.json');
        if (!res.ok) {
          showError(`health-log.json returned HTTP ${res.status}. The dashboard is probably not yet deployed.`);
          return;
        }

        let log;
        try {
          log = await res.json();
        } catch {
          showError('health-log.json could not be parsed as JSON.');
          return;
        }

        if (!Array.isArray(log) || log.length === 0) {
          showEmpty();
          return;
        }

        // Surface the latest check timestamp in the header.
        const latestTs = log.reduce((acc, r) => (r.timestamp > acc ? r.timestamp : acc), '');
        $lastUpd.textContent = latestTs ? formatLocal(latestTs) : '‚Äî';

        const groups = groupByEndpoint(log);

        renderCards(groups);
        renderChart(groups);
        renderMetricsTable(groups);
        renderCatalogueReport(document.getElementById('catalogue-container'), log);

        showDashboard();
      } catch (err) {
        showError(`Network error: ${err.message}`);
      }
    }

    init();

    // -------------------------------------------------------------------------
    // Weekly reports ‚Äî GitHub Issues integration
    // -------------------------------------------------------------------------

    const REPORTS_API_URL =
      'https://api.github.com/repos/erenkahraman/statpulse/issues' +
      '?labels=weekly-report&state=all&per_page=20&sort=created&direction=desc';

    // Module-level store so copyReport() can access raw bodies by index
    // without bloating each DOM element with a large encoded data attribute.
    let _reportIssues = [];

    /**
     * Escapes HTML special characters before inserting untrusted text into the DOM.
     * Applied before any other processing so markdown symbols in the text
     * cannot be interpreted as HTML tags.
     * @param {string} str
     * @returns {string}
     */
    function escHtml(str) {
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    /**
     * Renders inline markdown within a single line of already-escaped text.
     * Order matters: escHtml runs first so markdown symbols in literal text
     * are safe, then we apply bold/code/link transformations.
     * @param {string} text - Raw (unescaped) inline text.
     * @returns {string} HTML string with inline formatting applied.
     */
    function renderInline(text) {
      let s = escHtml(text);
      // **bold**
      s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      // `code`
      s = s.replace(/`([^`]+)`/g,
        '<code style="background:var(--bg-primary);padding:1px 4px;border-radius:3px;font-family:monospace;font-size:0.9em">$1</code>');
      // [link text](url)
      s = s.replace(/\[([^\]]+)\]\(([^)]+)\)/g,
        '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
      return s;
    }

    /**
     * Converts a subset of Markdown to safe HTML for rendering issue bodies.
     *
     * Handles: ## / ### headings ‚Üí <h4>, **bold**, `code`, [links](url),
     * | table | rows |, * / - bullet lists, --- horizontal rules, blank lines.
     * Everything else is wrapped in <p>.
     *
     * A line-by-line approach rather than regex-on-full-text gives predictable
     * behaviour for the structured Markdown our report script always produces.
     *
     * @param {string} text - Raw Markdown string (issue body).
     * @returns {string} HTML string safe to assign to innerHTML.
     */
    function parseMarkdown(text) {
      if (!text) return '';
      const lines  = text.split('\n');
      const out    = [];
      let inTable  = false;
      let tHeadDone = false;
      let inList   = false;

      const closeTable = () => { out.push('</tbody></table></div>'); inTable = false; tHeadDone = false; };
      const closeList  = () => { out.push('</ul>'); inList = false; };

      for (const line of lines) {
        const trimmed = line.trim();

        // ‚îÄ‚îÄ Table row ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        if (trimmed.startsWith('|')) {
          // Separator row: |---|---| transitions thead ‚Üí tbody
          if (/^\|[\s\-|:]+\|$/.test(trimmed)) {
            if (!tHeadDone) { out.push('</thead><tbody>'); tHeadDone = true; }
            continue;
          }

          if (inList) closeList();

          const cells = trimmed.replace(/^\||\|$/g, '').split('|');

          if (!inTable) {
            // First row of a new table is always the header
            out.push('<div class="table-wrapper"><table><thead>');
            inTable = true;
            tHeadDone = false;
            out.push('<tr>' + cells.map(c => `<th scope="col">${escHtml(c.trim())}</th>`).join('') + '</tr>');
          } else {
            out.push('<tr>' + cells.map(c => `<td>${renderInline(c.trim())}</td>`).join('') + '</tr>');
          }
          continue;
        }

        // Close any open table when we hit a non-table line
        if (inTable) closeTable();

        // ‚îÄ‚îÄ Headings (## and ###) ‚Üí <h4> to stay below existing h2 hierarchy ‚îÄ
        if (trimmed.startsWith('### ')) {
          if (inList) closeList();
          out.push(`<h4>${escHtml(trimmed.slice(4))}</h4>`);
          continue;
        }
        if (trimmed.startsWith('## ')) {
          if (inList) closeList();
          out.push(`<h4>${escHtml(trimmed.slice(3))}</h4>`);
          continue;
        }

        // ‚îÄ‚îÄ Bullet list (* item or - item) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        if (/^[*-] /.test(trimmed)) {
          if (!inList) { out.push('<ul>'); inList = true; }
          out.push(`<li>${renderInline(trimmed.slice(2))}</li>`);
          continue;
        }

        if (inList) closeList();

        // ‚îÄ‚îÄ Horizontal rule ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        if (/^---+$/.test(trimmed)) {
          out.push('<hr>');
          continue;
        }

        // ‚îÄ‚îÄ Blank line ‚Üí line break between paragraphs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        if (trimmed === '') {
          out.push('<br>');
          continue;
        }

        // ‚îÄ‚îÄ Default: paragraph ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        out.push(`<p>${renderInline(line)}</p>`);
      }

      if (inList)  closeList();
      if (inTable) closeTable();

      return out.join('\n');
    }

    /**
     * Copies the raw Markdown body of a report to the clipboard.
     * Looks up the body by index from _reportIssues rather than reading a
     * data attribute to avoid storing large strings in the DOM.
     * @param {HTMLButtonElement} btn - The clicked "Copy Report" button.
     */
    async function copyReport(btn) {
      const idx  = parseInt(btn.dataset.issueIdx, 10);
      const body = _reportIssues[idx]?.body || '';
      try {
        await navigator.clipboard.writeText(body);
        const orig = btn.textContent;
        btn.textContent = 'Copied ‚úì';
        setTimeout(() => { btn.textContent = orig; }, 2000);
      } catch {
        // Clipboard API requires HTTPS and user gesture ‚Äî silently no-op if
        // either condition isn't met rather than surfacing a confusing error.
      }
    }

    /**
     * Renders the list of weekly report issue cards.
     * Each card has a click-to-expand body area; buttons use stopPropagation
     * so their clicks don't also toggle the expand state.
     * @param {Array<Object>} issues - GitHub Issues API response array.
     */
    function renderReports(issues) {
      _reportIssues = issues;

      const $list = document.getElementById('reports-list');
      $list.innerHTML = '';

      issues.forEach((issue, idx) => {
        const bodyId        = `report-body-${idx}`;
        const stateCss      = issue.state === 'open' ? 'badge-open' : 'badge-closed';
        const stateLabel    = issue.state === 'open' ? 'Open' : 'Closed';
        const dateStr       = new Date(issue.created_at).toLocaleDateString();

        const article = document.createElement('article');
        article.className = 'report-card';
        article.setAttribute('role', 'listitem');
        article.setAttribute('aria-expanded', 'false');

        article.innerHTML = `
          <div class="report-card-header">
            <div class="report-card-title">${escHtml(issue.title)}</div>
            <div class="report-card-meta">
              <span class="badge ${stateCss}">${stateLabel}</span>
              #${issue.number} &bull; ${dateStr}
            </div>
            <div class="report-card-actions">
              <a href="${escHtml(issue.html_url)}"
                 target="_blank" rel="noopener noreferrer"
                 class="btn-outline"
                 aria-label="View issue #${issue.number} on GitHub"
                 onclick="event.stopPropagation()">View on GitHub ‚Üí</a>
              <button class="btn-filled"
                      data-issue-idx="${idx}"
                      aria-label="Copy report markdown for issue #${issue.number}"
                      onclick="event.stopPropagation(); copyReport(this)">Copy Report</button>
            </div>
          </div>
          <div class="report-body" id="${bodyId}"
               role="region"
               aria-label="Report content for issue #${issue.number}">
            <div class="report-body-inner">${parseMarkdown(issue.body || '')}</div>
          </div>
        `;

        // Toggle expand/collapse on card click ‚Äî buttons handle their own
        // events via stopPropagation so they don't bubble here.
        article.addEventListener('click', () => {
          const body       = document.getElementById(bodyId);
          const isExpanded = article.getAttribute('aria-expanded') === 'true';
          article.setAttribute('aria-expanded', String(!isExpanded));
          body.classList.toggle('expanded', !isExpanded);
        });

        $list.appendChild(article);
      });
    }

    /**
     * Fetches weekly report issues from the public GitHub API and renders them.
     * Runs independently of init() so the section is populated even if the
     * health-log.json fetch fails or the main dashboard hasn't loaded yet.
     */
    async function initWeeklyReports() {
      const $loading = document.getElementById('reports-loading');
      const $error   = document.getElementById('reports-error');
      const $empty   = document.getElementById('reports-empty');
      const $list    = document.getElementById('reports-list');

      try {
        const res = await fetch(REPORTS_API_URL, {
          headers: {
            'Accept':     'application/vnd.github.v3+json',
            'User-Agent': 'statpulse-dashboard/1.0',
          },
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const issues = await res.json();

        $loading.classList.add('hidden');

        if (!Array.isArray(issues) || issues.length === 0) {
          $empty.classList.remove('hidden');
          return;
        }

        renderReports(issues);
        $list.classList.remove('hidden');

      } catch {
        // Any network or API error falls through here ‚Äî show the error state
        // with a direct GitHub link so the user is never left without options.
        $loading.classList.add('hidden');
        $error.classList.remove('hidden');
      }
    }

    /* ‚îÄ‚îÄ Catalogue Change Report ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

    /**
     * Builds the human-readable label for a detected catalogue change.
     * @param {number} dsdDelta
     * @param {number} codelistDelta
     * @returns {string}
     */
    function buildChangeLabel(dsdDelta, codelistDelta) {
      const parts = [];
      if (dsdDelta !== 0) {
        parts.push(`${dsdDelta > 0 ? '+' : ''}${dsdDelta} DSD${Math.abs(dsdDelta) !== 1 ? 's' : ''}`);
      }
      if (codelistDelta !== 0) {
        parts.push(`${codelistDelta > 0 ? '+' : ''}${codelistDelta} Codelist${Math.abs(codelistDelta) !== 1 ? 's' : ''}`);
      }
      return parts.join(', ') + ' detected';
    }

    /**
     * Processes health-log.json data into a catalogue change report.
     * Groups per-endpoint records into logical check runs (by minute-level timestamp),
     * then compares consecutive runs to detect changes in DSD and Codelist counts.
     * @param {Array} logData - Parsed health-log.json array
     * @returns {{ events: Array, summary: Object, sparkline: Array }}
     */
    function buildCatalogueReport(logData) {
      const STRUCTURES_NAME = 'Structures';
      const CODELISTS_NAME  = 'Codelists';

      // Group per-endpoint records into per-run objects keyed by minute timestamp.
      const runMap = new Map();
      logData.forEach(record => {
        const key = record.timestamp.slice(0, 16);
        if (!runMap.has(key)) runMap.set(key, {});
        const run = runMap.get(key);
        if (record.endpoint === STRUCTURES_NAME) {
          run.timestamp = record.timestamp;
          run.dsdCount  = Number(record.extraMetric?.value) || null;
        }
        if (record.endpoint === CODELISTS_NAME) {
          run.codelistCount = Number(record.extraMetric?.value) || null;
        }
      });

      // Sort runs chronologically.
      const runs = [...runMap.values()]
        .filter(r => r.timestamp)
        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

      // Walk runs sequentially, emit baseline on first and change events on delta.
      const events = [];
      let baselineDsd = null, baselineCodelist = null;
      runs.forEach((run, idx) => {
        if (idx === 0) {
          baselineDsd = run.dsdCount;
          baselineCodelist = run.codelistCount;
          events.push({
            timestamp: run.timestamp, type: 'baseline',
            dsdCount: run.dsdCount, codelistCount: run.codelistCount,
            dsdDelta: 0, codelistDelta: 0,
            label: 'Monitoring started ‚Äî baseline recorded',
          });
          return;
        }
        const dsdDelta      = (run.dsdCount      ?? baselineDsd)      - (baselineDsd      ?? 0);
        const codelistDelta = (run.codelistCount ?? baselineCodelist) - (baselineCodelist ?? 0);
        if (dsdDelta !== 0 || codelistDelta !== 0) {
          events.push({
            timestamp: run.timestamp, type: 'change',
            dsdCount: run.dsdCount, codelistCount: run.codelistCount,
            dsdDelta, codelistDelta,
            label: buildChangeLabel(dsdDelta, codelistDelta),
          });
          if (run.dsdCount      !== null) baselineDsd      = run.dsdCount;
          if (run.codelistCount !== null) baselineCodelist = run.codelistCount;
        }
      });

      const changeEvents = events.filter(e => e.type === 'change');
      const latestRun    = runs[runs.length - 1] ?? {};
      const firstRun     = runs[0] ?? {};
      const summary = {
        totalRuns:        runs.length,
        totalChanges:     changeEvents.length,
        currentDsd:       latestRun.dsdCount,
        currentCodelist:  latestRun.codelistCount,
        dsdNetChange:     (latestRun.dsdCount      ?? 0) - (firstRun.dsdCount      ?? 0),
        codelistNetChange:(latestRun.codelistCount ?? 0) - (firstRun.codelistCount ?? 0),
        monitoringSince:  firstRun.timestamp,
      };

      // Last 20 runs for sparkline.
      const sparkline = runs.slice(-20).map(r => ({ t: r.timestamp, dsd: r.dsdCount, cl: r.codelistCount }));

      return { events, summary, sparkline };
    }

    /**
     * Renders the catalogue change report into the given container element.
     * Builds summary stat cards, a Chart.js sparkline, and a vertical change timeline.
     * @param {HTMLElement} container
     * @param {Array} logData - Parsed health-log.json array
     */
    function renderCatalogueReport(container, logData) {
      const { events, summary, sparkline } = buildCatalogueReport(logData);

      const netDsdClass  = summary.dsdNetChange > 0 ? 'positive' : summary.dsdNetChange < 0 ? 'negative' : 'neutral';
      const netDsdPrefix = summary.dsdNetChange > 0 ? '+' : '';

      const summaryHtml = `
        <div class="catalogue-summary-grid">
          <div class="catalogue-stat-card">
            <span class="catalogue-stat-value">${summary.currentDsd ?? '‚Äî'}</span>
            <span class="catalogue-stat-label">Current DSDs</span>
          </div>
          <div class="catalogue-stat-card">
            <span class="catalogue-stat-value">${summary.currentCodelist ?? '‚Äî'}</span>
            <span class="catalogue-stat-label">Current Codelists</span>
          </div>
          <div class="catalogue-stat-card">
            <span class="catalogue-stat-value ${netDsdClass}">${netDsdPrefix}${summary.dsdNetChange}</span>
            <span class="catalogue-stat-label">Net DSD Change</span>
          </div>
          <div class="catalogue-stat-card">
            <span class="catalogue-stat-value">${summary.totalChanges}</span>
            <span class="catalogue-stat-label">Catalogue Events</span>
          </div>
        </div>`;

      const sparklineHtml = `
        <div class="sparkline-wrapper">
          <p class="sparkline-title">Catalogue size over last 20 checks</p>
          <div class="sparkline-duo">
            <div class="sparkline-item">
              <p class="sparkline-item-label">Data Structures (DSDs)</p>
              <canvas id="sparkline-dsd" height="80"></canvas>
            </div>
            <div class="sparkline-item">
              <p class="sparkline-item-label">Codelists</p>
              <canvas id="sparkline-cl" height="80"></canvas>
            </div>
          </div>
        </div>`;

      let timelineHtml;
      if (events.length === 0) {
        timelineHtml = `<div class="catalogue-empty-state">No catalogue changes detected in the monitoring window.<br>The SDMX artefact catalogue has remained stable.</div>`;
      } else {
        const items = [...events].reverse().map(ev => {
          const dotClass = ev.type === 'baseline'                               ? 'baseline'
            : ev.dsdDelta > 0  && ev.codelistDelta >= 0                        ? 'addition'
            : ev.dsdDelta < 0  && ev.codelistDelta <= 0                        ? 'deletion'
            :                                                                    'mixed';

          let bodyHtml;
          if (ev.type === 'baseline') {
            bodyHtml = `<div class="event-baseline-note">Baseline: ${ev.dsdCount ?? '‚Äî'} DSDs, ${ev.codelistCount ?? '‚Äî'} Codelists</div>`;
          } else {
            const rows = [];
            if (ev.dsdDelta !== 0) {
              const prev = (ev.dsdCount      ?? 0) - ev.dsdDelta;
              const dc   = ev.dsdDelta > 0 ? 'delta-positive' : 'delta-negative';
              rows.push(`<tr><td>DSDs</td><td>${prev}</td><td>${ev.dsdCount ?? '‚Äî'}</td><td class="${dc}">${ev.dsdDelta > 0 ? '+' : ''}${ev.dsdDelta}</td></tr>`);
            }
            if (ev.codelistDelta !== 0) {
              const prev = (ev.codelistCount ?? 0) - ev.codelistDelta;
              const dc   = ev.codelistDelta > 0 ? 'delta-positive' : 'delta-negative';
              rows.push(`<tr><td>Codelists</td><td>${prev}</td><td>${ev.codelistCount ?? '‚Äî'}</td><td class="${dc}">${ev.codelistDelta > 0 ? '+' : ''}${ev.codelistDelta}</td></tr>`);
            }
            bodyHtml = `<table class="event-delta-table"><thead><tr><th>Metric</th><th>Before</th><th>After</th><th>Change</th></tr></thead><tbody>${rows.join('')}</tbody></table>`;
          }

          return `<div class="catalogue-event">
            <div class="event-dot ${dotClass}" aria-hidden="true"></div>
            <div class="event-timestamp">${formatLocal(ev.timestamp)}</div>
            <div class="event-label">${ev.label}</div>
            ${bodyHtml}
          </div>`;
        }).join('');
        timelineHtml = `<div class="catalogue-timeline">${items}</div>`;
      }

      const footerHtml = `<p class="catalogue-footer-note">Changes are detected by comparing consecutive 6-hour health check snapshots. Intra-check changes may not be captured if they occur and revert between monitoring intervals.</p>`;

      container.innerHTML = summaryHtml + sparklineHtml + timelineHtml + footerHtml;

      if (sparkline.length > 0) {
        /* Two independent charts prevent the 5√ó magnitude gap between DSD counts
           (~530) and Codelist counts (~2591) from collapsing one series to the
           chart floor on a shared Y-axis. Each chart auto-scales to its own range. */

        if (window._sparkDsd) { window._sparkDsd.destroy(); }
        if (window._sparkCl)  { window._sparkCl.destroy();  }

        // min/max on Chart.js scale config must be static numbers ‚Äî they are not
        // scriptable options in Chart.js 4.x, so passing a callback is silently
        // ignored (coerces to NaN ‚Üí treated as unset ‚Üí falls back to a 0 baseline).
        // Compute the per-series bounds here, before building the config object.
        const sparklineConfig = (data, color, label) => {
          const vals = data.map(r => r.dsd ?? r.cl).filter(v => v != null);
          const yMin = vals.length ? Math.floor(Math.min(...vals) * 0.98) : 0;
          const yMax = vals.length ? Math.ceil(Math.max(...vals) * 1.02) : 100;
          return {
            type: 'line',
            data: {
              labels: data.map(r => new Date(r.t).toLocaleString()),
              datasets: [{
                label,
                data: data.map(r => r.dsd ?? r.cl),
                borderColor: color,
                backgroundColor: color + '1a',
                borderWidth: 2,
                pointRadius: data.length <= 5 ? 3 : 0,
                fill: true,
                tension: 0.3,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                x: { display: false },
                y: { display: false, min: yMin, max: yMax },
              }
            }
          };
        };

        window._sparkDsd = new Chart(
          document.getElementById('sparkline-dsd'),
          sparklineConfig(
            sparkline.map(r => ({ t: r.t, dsd: r.dsd })),
            '#2f81f7',
            'DSDs'
          )
        );

        window._sparkCl = new Chart(
          document.getElementById('sparkline-cl'),
          sparklineConfig(
            sparkline.map(r => ({ t: r.t, cl: r.cl })),
            '#3fb950',
            'Codelists'
          )
        );
      }
    }

    /* ‚îÄ‚îÄ Platform Reports tab switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    // The tab buttons are in the HTML above this <script> block, so they are
    // available in the DOM immediately ‚Äî no DOMContentLoaded needed.
    document.querySelectorAll('.reports-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.reports-tab').forEach(t => {
          t.classList.remove('active');
          t.setAttribute('aria-selected', 'false');
        });
        document.getElementById('tab-weekly').classList.add('hidden');
        document.getElementById('tab-catalogue').classList.add('hidden');
        tab.classList.add('active');
        tab.setAttribute('aria-selected', 'true');
        document.getElementById(tab.getAttribute('aria-controls')).classList.remove('hidden');
      });
    });

    initWeeklyReports();

    /* ‚îÄ‚îÄ SDMX Guide Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    // The guide panel HTML is injected AFTER this <script> block, so any
    // querySelector call here returns null at parse time. DOMContentLoaded
    // defers all wiring until the full document has been parsed.
    document.addEventListener('DOMContentLoaded', function() {
      const guideBtn     = document.querySelector('.guide-btn');
      const guideOverlay = document.querySelector('.guide-overlay');
      const guidePanel   = document.querySelector('.guide-panel');
      const guideClose   = document.querySelector('.guide-close');
      const guideTabs    = document.querySelectorAll('.guide-tab');
      const guidePanels  = document.querySelectorAll('.guide-tabpanel');

      function openGuide() {
        // Lock body scroll by class rather than inline style to stay consistent
        // with the class-driven styling approach used throughout the dashboard.
        document.body.classList.add('panel-open');
        guideOverlay.classList.add('visible');
        guidePanel.classList.add('open');
        guidePanel.setAttribute('aria-hidden', 'false');
        guideBtn.setAttribute('aria-expanded', 'true');
      }

      function closeGuide() {
        document.body.classList.remove('panel-open');
        guideOverlay.classList.remove('visible');
        guidePanel.classList.remove('open');
        guidePanel.setAttribute('aria-hidden', 'true');
        guideBtn.setAttribute('aria-expanded', 'false');
      }

      guideBtn.addEventListener('click', openGuide);
      guideClose.addEventListener('click', closeGuide);
      guideOverlay.addEventListener('click', closeGuide);

      // Escape key closes the panel ‚Äî standard accessible modal pattern.
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape' && guidePanel.classList.contains('open')) closeGuide();
      });

      guideTabs.forEach((tab, i) => {
        tab.addEventListener('click', () => {
          guideTabs.forEach(t  => { t.classList.remove('active');
                                     t.setAttribute('aria-selected', 'false'); });
          guidePanels.forEach(p => p.classList.add('hidden'));
          tab.classList.add('active');
          tab.setAttribute('aria-selected', 'true');
          guidePanels[i].classList.remove('hidden');
        });
      });

      // Accordion ‚Äî each trigger collapses siblings before opening itself,
      // so only one glossary term is expanded at a time.
      document.querySelectorAll('.accordion-trigger').forEach(trigger => {
        trigger.addEventListener('click', () => {
          const item   = trigger.closest('.accordion-item');
          const body   = item.querySelector('.accordion-body');
          const isOpen = item.classList.contains('open');
          // Collapse all siblings first so only one accordion item is open at a time.
          trigger.closest('.accordion').querySelectorAll('.accordion-item').forEach(i => {
            i.classList.remove('open');
            i.querySelector('.accordion-body').classList.remove('expanded');
            i.querySelector('.accordion-trigger').setAttribute('aria-expanded', 'false');
          });
          if (!isOpen) {
            item.classList.add('open');
            body.classList.add('expanded');
            trigger.setAttribute('aria-expanded', 'true');
          }
        });
      });
    }); // end DOMContentLoaded
  </script>


  <!-- ==================================================================
       SDMX Guide Panel
       Floating trigger + slide-in reference panel with 3-tab navigation.
       z-index stacking: btn(1000) < overlay(1001) < panel(1002).
  ================================================================== -->

  <!-- Backdrop ‚Äî covers the page behind the panel; clicking it closes it -->
  <div class="guide-overlay" aria-hidden="true"></div>

  <!-- Floating trigger ‚Äî fixed bottom-right corner -->
  <button class="guide-btn"
          aria-label="Open SDMX Reference Guide"
          aria-expanded="false"
          aria-controls="guide-panel">üìñ SDMX Guide</button>

  <!-- Slide-in reference panel -->
  <!-- span used for title instead of h2 to avoid inheriting the global
       h2 border-bottom rule which would produce a double border here. -->
  <aside id="guide-panel"
         class="guide-panel"
         role="complementary"
         aria-label="SDMX Reference Guide"
         aria-hidden="true">

    <div class="guide-panel-header">
      <span class="guide-panel-title">SDMX Reference Guide</span>
      <button class="guide-close" aria-label="Close SDMX Reference Guide">√ó</button>
    </div>

    <nav class="guide-tabs" role="tablist" aria-label="Guide sections">
      <button class="guide-tab active"
              role="tab"
              aria-selected="true"
              aria-controls="guide-tab-0">What is statpulse</button>
      <button class="guide-tab"
              role="tab"
              aria-selected="false"
              aria-controls="guide-tab-1">SDMX Explained</button>
      <button class="guide-tab"
              role="tab"
              aria-selected="false"
              aria-controls="guide-tab-2">How to Read This Dashboard</button>
    </nav>

    <div class="guide-tab-content">

      <!-- ‚îÄ‚îÄ Tab 1: What is statpulse ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div id="guide-tab-0" class="guide-tabpanel" role="tabpanel" aria-labelledby="gtab-0">

        <h3 class="guide-section-title">What is statpulse?</h3>
        <p class="guide-prose">statpulse is an automated API health monitoring platform
          built specifically for the SIS-CC .Stat Suite ‚Äî the open-source SDMX dissemination
          platform used by OECD, national statistical institutes, and international
          organisations to publish official statistics. It monitors three live SDMX endpoints
          every six hours, detects performance anomalies using rolling averages, tracks
          structural catalogue changes over time, and publishes weekly governance reports
          automatically as GitHub Issues ‚Äî all running on free GitHub infrastructure with
          no backend or database.</p>

        <!-- CSS-only flow diagram ‚Äî four boxes represent the full monitoring pipeline -->
        <div class="flow-diagram"
             role="img"
             aria-label="Architecture: GitHub Actions checks SDMX API every 6 hours, results shown in dashboard and published as weekly GitHub Issues">
          <div class="flow-box">
            <span class="flow-icon" aria-hidden="true">‚öôÔ∏è</span>
            <span class="flow-label">GitHub Actions</span>
            <span class="flow-desc">Runs every 6 hours</span>
          </div>
          <span class="flow-arrow" aria-hidden="true">‚Üí</span>
          <div class="flow-box">
            <span class="flow-icon" aria-hidden="true">üåê</span>
            <span class="flow-label">SIS-CC NSI API</span>
            <span class="flow-desc">Live SDMX endpoints</span>
          </div>
          <span class="flow-arrow" aria-hidden="true">‚Üí</span>
          <div class="flow-box">
            <span class="flow-icon" aria-hidden="true">üìä</span>
            <span class="flow-label">Dashboard + Reports</span>
            <span class="flow-desc">GitHub Pages</span>
          </div>
          <span class="flow-arrow" aria-hidden="true">‚Üí</span>
          <div class="flow-box">
            <span class="flow-icon" aria-hidden="true">üìã</span>
            <span class="flow-label">GitHub Issues</span>
            <span class="flow-desc">Weekly auto-reports</span>
          </div>
        </div>

        <h4 class="guide-subsection-title">Why it matters</h4>
        <div class="why-cards">
          <div class="why-card">
            <span class="why-icon" aria-hidden="true">üîí</span>
            <p class="why-title">Platform Reliability</p>
            <p class="why-text">Statistical organisations depend on continuous API
              availability. Downtime means analysts, policymakers, and citizens
              cannot access official statistics.</p>
          </div>
          <div class="why-card">
            <span class="why-icon" aria-hidden="true">üìã</span>
            <p class="why-title">Data Governance</p>
            <p class="why-text">Tracking DSD and Codelist catalogue size over time
              detects unreviewed structural changes before they affect
              downstream consumers.</p>
          </div>
          <div class="why-card">
            <span class="why-icon" aria-hidden="true">üåç</span>
            <p class="why-title">Open Source Transparency</p>
            <p class="why-text">statpulse runs entirely on free GitHub infrastructure
              ‚Äî no cloud costs, no vendor lock-in.</p>
          </div>
        </div>

      </div>

      <!-- ‚îÄ‚îÄ Tab 2: SDMX Explained ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div id="guide-tab-1" class="guide-tabpanel hidden" role="tabpanel" aria-labelledby="gtab-1">

        <h3 class="guide-section-title">Understanding SDMX</h3>
        <p class="guide-prose">SDMX (Statistical Data and Metadata eXchange) is the
          international standard for sharing official statistics. It defines both the data
          format and the API protocol used by central banks, national statistics offices,
          and international organisations worldwide.</p>

        <!-- Single-open accordion ‚Äî only one term expanded at a time (enforced by JS) -->
        <div class="accordion" role="list" aria-label="SDMX glossary">

          <div class="accordion-item" role="listitem">
            <button class="accordion-trigger" aria-expanded="false" aria-controls="gloss-dsd">
              <span class="accordion-chevron" aria-hidden="true">‚ñ∂</span>
              DSD ‚Äî Data Structure Definition
            </button>
            <div class="accordion-body" id="gloss-dsd">
              <div class="accordion-body-inner">
                <p>The schema that defines the structure of a statistical dataset. A DSD specifies
                  which dimensions are used (e.g. country, frequency, indicator), what codelists
                  they reference, and which attributes accompany observations. Think of it as the
                  table schema before any data is loaded.</p>
                <div class="tag-list" aria-label="Related modules">
                  <span class="tag">.Stat Core</span>
                  <span class="tag">DLM</span>
                </div>
              </div>
            </div>
          </div>

          <div class="accordion-item" role="listitem">
            <button class="accordion-trigger" aria-expanded="false" aria-controls="gloss-dataflow">
              <span class="accordion-chevron" aria-hidden="true">‚ñ∂</span>
              Dataflow
            </button>
            <div class="accordion-body" id="gloss-dataflow">
              <div class="accordion-body-inner">
                <p>A named, published view of data that conforms to a DSD. While a DSD defines
                  structure, a Dataflow is what end users actually query. The TOURISM_TRIPS
                  dataset statpulse monitors is a Dataflow.</p>
                <div class="tag-list" aria-label="Related modules">
                  <span class="tag">.Stat Core</span>
                  <span class="tag">Data Explorer</span>
                </div>
              </div>
            </div>
          </div>

          <div class="accordion-item" role="listitem">
            <button class="accordion-trigger" aria-expanded="false" aria-controls="gloss-codelist">
              <span class="accordion-chevron" aria-hidden="true">‚ñ∂</span>
              Codelist
            </button>
            <div class="accordion-body" id="gloss-codelist">
              <div class="accordion-body-inner">
                <p>A controlled vocabulary of allowed values for a dimension or attribute.
                  For example, a FREQ codelist contains codes like A (Annual), Q (Quarterly),
                  M (Monthly). statpulse currently tracks 2,591 codelists on the SIS-CC demo
                  instance.</p>
                <div class="tag-list" aria-label="Related modules">
                  <span class="tag">.Stat Core</span>
                </div>
              </div>
            </div>
          </div>

          <div class="accordion-item" role="listitem">
            <button class="accordion-trigger" aria-expanded="false" aria-controls="gloss-nsi">
              <span class="accordion-chevron" aria-hidden="true">‚ñ∂</span>
              NSI Web Service
            </button>
            <div class="accordion-body" id="gloss-nsi">
              <div class="accordion-body-inner">
                <p>The National Statistics Instance web service ‚Äî the SDMX REST API endpoint
                  that .Stat Core exposes. statpulse monitors this layer directly. It handles
                  both structural queries (/rest/datastructure) and data queries (/rest/data).</p>
                <div class="tag-list" aria-label="Related modules">
                  <span class="tag">.Stat Core</span>
                </div>
              </div>
            </div>
          </div>

          <div class="accordion-item" role="listitem">
            <button class="accordion-trigger" aria-expanded="false" aria-controls="gloss-gsbpm">
              <span class="accordion-chevron" aria-hidden="true">‚ñ∂</span>
              GSBPM
            </button>
            <div class="accordion-body" id="gloss-gsbpm">
              <div class="accordion-body-inner">
                <p>The Generic Statistical Business Process Model ‚Äî an international framework
                  describing all phases of statistical production from Specify Needs to Evaluate.
                  The .Stat Suite is designed to support the full GSBPM lifecycle.</p>
                <div class="tag-list" aria-label="Related modules">
                  <span class="tag">Framework</span>
                </div>
              </div>
            </div>
          </div>

          <div class="accordion-item" role="listitem">
            <button class="accordion-trigger" aria-expanded="false" aria-controls="gloss-constraint">
              <span class="accordion-chevron" aria-hidden="true">‚ñ∂</span>
              Content Constraint
            </button>
            <div class="accordion-body" id="gloss-constraint">
              <div class="accordion-body-inner">
                <p>An SDMX artefact that restricts which dimension value combinations are valid
                  for a given dataflow. It prevents users from querying impossible combinations
                  and improves API performance by reducing result sets.</p>
                <div class="tag-list" aria-label="Related modules">
                  <span class="tag">.Stat Core</span>
                </div>
              </div>
            </div>
          </div>

          <div class="accordion-item" role="listitem">
            <button class="accordion-trigger" aria-expanded="false" aria-controls="gloss-transfer">
              <span class="accordion-chevron" aria-hidden="true">‚ñ∂</span>
              Transfer Service
            </button>
            <div class="accordion-body" id="gloss-transfer">
              <div class="accordion-body-inner">
                <p>The .Stat Suite microservice responsible for loading data into the Core
                  database. It handles validation (basic and advanced), queuing, and the
                  /init/dataflow initialisation step required before data can be uploaded.</p>
                <div class="tag-list" aria-label="Related modules">
                  <span class="tag">.Stat Core</span>
                </div>
              </div>
            </div>
          </div>

        </div>

        <h4 class="guide-subsection-title">SDMX REST API Anatomy</h4>
        <pre class="api-anatomy">GET https://nsi-demo-stable.siscc.org/rest/data/{agency},{dataflow},{version}/{key}
                                                  ‚Üë           ‚Üë          ‚Üë        ‚Üë
                                               Agency ID  Dataflow   Version   Filter Key</pre>

        <div class="table-wrapper">
          <table aria-label="Endpoints statpulse monitors and what each measures">
            <thead>
              <tr>
                <th scope="col">What statpulse queries</th>
                <th scope="col">Endpoint</th>
                <th scope="col">What it measures</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Datastructure catalogue</td>
                <td><code class="code-mono">/rest/datastructure/all/all/all</code></td>
                <td>DSD count, availability</td>
              </tr>
              <tr>
                <td>Tourism dataset</td>
                <td><code class="code-mono">/rest/data/OECD.CFE,INBOUND@TOURISM_TRIPS,2.0</code></td>
                <td>Data query speed</td>
              </tr>
              <tr>
                <td>Codelist catalogue</td>
                <td><code class="code-mono">/rest/codelist/all/all/latest</code></td>
                <td>Codelist count, availability</td>
              </tr>
            </tbody>
          </table>
        </div>

      </div>

      <!-- ‚îÄ‚îÄ Tab 3: How to Read This Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div id="guide-tab-2" class="guide-tabpanel hidden" role="tabpanel" aria-labelledby="gtab-2">

        <h3 class="guide-section-title">Reading the Dashboard</h3>

        <div class="howto-block">
          <span class="howto-icon" aria-hidden="true">üü¢</span>
          <div>
            <p class="howto-title">Endpoint Status Cards</p>
            <p class="howto-text">Each card represents one monitored SDMX API endpoint.
              OPERATIONAL (green) = responding within thresholds. DEGRADED (yellow) =
              response time is 2‚Äì3√ó above the rolling average. DOWN (red) = HTTP error
              or timeout.</p>
          </div>
        </div>

        <div class="howto-block">
          <span class="howto-icon" aria-hidden="true">üìà</span>
          <div>
            <p class="howto-title">Response Time Chart</p>
            <p class="howto-text">Shows the last 20 health checks as a line chart. Each
              coloured line is one endpoint. X-axis is time, Y-axis is milliseconds. Spikes
              indicate temporary slowdowns; an upward trend may indicate infrastructure
              issues.</p>
          </div>
        </div>

        <div class="howto-block">
          <span class="howto-icon" aria-hidden="true">‚ö†Ô∏è</span>
          <div>
            <p class="howto-title">Anomaly Detection</p>
            <p class="howto-text">statpulse computes a 10-check rolling average per endpoint.
              Readings above 2√ó trigger a warning; above 3√ó trigger a critical alert.
              Detection activates only after 5 or more data points are collected.</p>
          </div>
        </div>

        <div class="howto-block">
          <span class="howto-icon" aria-hidden="true">üìä</span>
          <div>
            <p class="howto-title">Domain Metric Trends</p>
            <p class="howto-text">Tracks domain-specific metrics: DSD catalogue count,
              data query response size in KB, and Codelist count. Unexpected drops may
              indicate structural deletions; spikes may indicate unreviewed uploads.</p>
          </div>
        </div>

        <div class="howto-block">
          <span class="howto-icon" aria-hidden="true">üìã</span>
          <div>
            <p class="howto-title">Weekly Health Reports</p>
            <p class="howto-text">Every Monday at 09:00 UTC, a GitHub Actions workflow
              generates a structured platform health report as a GitHub Issue. The section
              below fetches and renders these reports inline.</p>
          </div>
        </div>

        <div class="howto-block">
          <span class="howto-icon" aria-hidden="true">üóÇ</span>
          <div>
            <p class="howto-title">Catalogue Change Report</p>
            <p class="howto-text">Tracks additions and deletions to the SDMX artefact
              catalogue over time. Each monitoring run compares the current DSD and
              Codelist counts against the previous check. Changes are surfaced as
              timestamped events in a vertical timeline with before/after delta tables.</p>
          </div>
        </div>

      </div>

    </div>
  </aside>

</body>
</html>
